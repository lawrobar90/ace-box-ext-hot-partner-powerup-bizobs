#
# Ultra-Simplified Partner PowerUp BizObs - ACE-BOX Use Case
# Fixes the systemd permission issue by avoiding it completely
# 
---
- debug:
    msg: "ðŸš€ Starting Ultra-Simplified Partner PowerUp BizObs deployment..."

# Store role path for file references
- set_fact:
    role_path_abs: "{{ role_path }}"

#
# STEP 1: Authentication & Dynatrace Setup
#
- include_role:
    name: dt-access-token
  vars:
    access_token_var_name: "monaco_cleanup_api_token"
    access_token_scope:
      [
        "slo.read",
        "slo.write", 
        "CaptureRequestData",
        "credentialVault.read",
        "credentialVault.write",
        "DataExport",
        "DataPrivacy",
        "ExternalSyntheticIntegration",
        "ReadConfig",
        "WriteConfig",
        "events.ingest",
        "settings.read",
        "settings.write",
        "metrics.ingest",
        "openTelemetryTrace.ingest",
        "logs.ingest"
      ]

#
# STEP 2: Infrastructure Setup
#
- include_role:
    name: "microk8s"

#
# STEP 3: Monaco Configuration 
#
- include_role:
    name: "monaco-v2"

#
# STEP 4: Mattermost
#
- include_role:
    name: "mattermost"

#
# STEP 5: OneAgent
#
- include_role:
    name: "dt-oneagent-classic"

#
# STEP 6: BizObs Application (Ultra-Simple Version - No systemd!)
#
- include_tasks: ../app-partner-powerup-bizobs/tasks/main-ultra-simple.yml

#
# STEP 7: Dashboard Setup
#
- name: Configure Dashboard with BizObs links
  block:
    - set_fact:
        include_dashboard_value_file: "{{ role_path_abs }}/templates/bizobs-dashboard.yml.j2"

    - include_role:
        name: dashboard
        tasks_from: template-values-file

    - include_role:
        name: "dashboard"

# Final success message
- debug:
    msg: |
      âœ… Partner PowerUp BizObs deployed successfully!
      
      ðŸ“Š ACCESS URLS:
      - Dashboard: {{ ingress_protocol | default('http') }}://dashboard.{{ ingress_domain }}/
      - Mattermost: {{ ingress_protocol | default('http') }}://mattermost.{{ ingress_domain }}/
      - BizObs App: {{ ingress_protocol | default('http') }}://bizobs.{{ ingress_domain }}/
      - Health Check: {{ ingress_protocol | default('http') }}://bizobs.{{ ingress_domain }}/api/health
      
      ðŸŽ¯ App is running with nohup - no systemd issues!