#
# Partner PowerUp BizObs - Clean ACE-BOX Role
#

---
- debug:
    msg: " Partner PowerUp BizObs - ACE-BOX deployment"

- set_fact:
    bizobs_repo_url: "https://github.com/lawrobar90/Partner-PowerUp-BizObs-App.git"
    bizobs_app_dir: "/home/{{ ace_box_user | default('dt_training') }}/Partner-PowerUp-BizObs-App"
    bizobs_domain: "bizobs.{{ ingress_domain }}"

- include_role:
    name: dt-access-token
  vars:
    access_token_var_name: "monaco_cleanup_api_token"
    access_token_scope: ["ReadConfig", "WriteConfig", "events.ingest"]

- include_role:
    name: "microk8s"

- include_role:
    name: "nodejs"

- name: Clone repository
  ansible.builtin.git:
    repo: "{{ bizobs_repo_url }}"
    dest: "{{ bizobs_app_dir }}"
    version: "main"
    force: yes
  become_user: "{{ ace_box_user | default('dt_training') }}"

- name: Install dependencies
  ansible.builtin.command:
    cmd: npm install --production
    chdir: "{{ bizobs_app_dir }}"
  become_user: "{{ ace_box_user | default('dt_training') }}"

- name: Copy optimized startup script
  ansible.builtin.copy:
    src: "{{ role_path }}/../../start-server-ace-optimized.sh"
    dest: "{{ bizobs_app_dir }}/start-server.sh"
    mode: '0755'
    force: yes

- name: Start application
  ansible.builtin.shell: /bin/sh ./start-server.sh
  become: true
  args:
    chdir: "{{ bizobs_app_dir }}"
  async: 30
  poll: 0

- name: Wait for startup
  ansible.builtin.wait_for:
    port: 8080
    host: localhost
    delay: 5
    timeout: 30

- include_role:
    name: "dt-oneagent-classic"

- include_role:
    name: "monaco-v2"

- include_role:
    name: "mattermost"

- include_role:
    name: "dashboard"

- debug:
    msg: " Partner PowerUp BizObs deployed successfully!"
