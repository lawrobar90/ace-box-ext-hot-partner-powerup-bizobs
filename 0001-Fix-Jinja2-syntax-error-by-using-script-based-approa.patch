From 13358873531c41ddd11767589368903c0102b8cf Mon Sep 17 00:00:00 2001
From: dynatrace <ace@dynatrace.com>
Date: Sat, 25 Oct 2025 17:27:44 +0000
Subject: [PATCH 1/2] Fix Jinja2 syntax error by using script-based approach
 for npm install

---
 .../app-partner-powerup-bizobs/tasks/main.yml | 71 +++++++++++--------
 1 file changed, 40 insertions(+), 31 deletions(-)

diff --git a/roles/app-partner-powerup-bizobs/tasks/main.yml b/roles/app-partner-powerup-bizobs/tasks/main.yml
index c010e35..a17f99e 100644
--- a/roles/app-partner-powerup-bizobs/tasks/main.yml
+++ b/roles/app-partner-powerup-bizobs/tasks/main.yml
@@ -148,38 +148,47 @@
   become_user: "{{ bizobs_user | default('dt_training') }}"
   failed_when: false
 
+- name: Create npm installation script
+  copy:
+    content: |
+      #!/bin/bash
+      set -e
+      BIZOBS_PATH="{{ bizobs_home | default('/home/dt_training') }}/bizobs-app"
+      cd "$BIZOBS_PATH"
+      
+      # Verify we're in the right directory
+      if [ ! -f "package.json" ]; then
+        echo "ERROR: package.json not found in $(pwd)"
+        ls -la
+        exit 1
+      fi
+      
+      # Clean npm cache and install
+      npm cache clean --force 2>/dev/null || true
+      
+      # Try npm install with multiple methods
+      if npm install --unsafe-perm; then
+        echo "npm install successful"
+      elif npm install --unsafe-perm --no-optional; then
+        echo "npm install successful (without optional packages)"
+      elif npm install --unsafe-perm --legacy-peer-deps; then
+        echo "npm install successful (with legacy peer deps)"
+      else
+        echo "npm install completed with warnings, continuing..."
+      fi
+      
+      # Verify node_modules exists
+      if [ -d "node_modules" ]; then
+        echo "node_modules directory created successfully"
+        ls -la node_modules/ | head -5
+      else
+        echo "WARNING: node_modules directory not found"
+      fi
+    dest: /tmp/npm_install.sh
+    mode: '0755'
+
 - name: Install Node.js dependencies with enhanced error handling
-  shell: |
-    cd "{{ bizobs_home | default('/home/dt_training') }}/bizobs-app"
-    
-    # Verify we're in the right directory
-    if [ ! -f "package.json" ]; then
-      echo "ERROR: package.json not found in $(pwd)"
-      ls -la
-      exit 1
-    fi
-    
-    # Clean npm cache and install
-    npm cache clean --force 2>/dev/null || true
-    
-    # Try npm install with multiple methods
-    if npm install --unsafe-perm; then
-      echo "npm install successful"
-    elif npm install --unsafe-perm --no-optional; then
-      echo "npm install successful (without optional packages)"
-    elif npm install --unsafe-perm --legacy-peer-deps; then
-      echo "npm install successful (with legacy peer deps)"
-    else
-      echo "npm install completed with warnings, continuing..."
-    fi
-    
-    # Verify node_modules exists
-    if [ -d "node_modules" ]; then
-      echo "node_modules directory created successfully"
-      ls -la node_modules/ | head -5
-    else
-      echo "WARNING: node_modules directory not found"
-    fi
+  command: /tmp/npm_install.sh
   become: true
   become_user: "{{ bizobs_user | default('dt_training') }}"
   failed_when: false
-- 
2.34.1

